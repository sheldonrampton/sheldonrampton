<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>Batch operations</title>
<link href="tabs.css" rel="stylesheet" type="text/css">
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.8 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
</div>
<div class="contents">
<h1>Batch operations</h1><table border="0" cellpadding="0" cellspacing="0">
<tr><td></td></tr>
<tr><td colspan="2"><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__batch.html#g9ff3f18b3bdd1d62ab7ac681a22a7170">batch_set</a> ($batch_definition)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__batch.html#g35560f242c9a5da0d136e652d4d1da47">batch_process</a> ($redirect=NULL, $url=NULL)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">&amp;&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__batch.html#g971f5246c6e8e536d0b20529fb2e2638">batch_get</a> ()</td></tr>

</table>
<hr><a name="_details"></a><h2>Detailed Description</h2>
End of "defgroup form_api".<p>
Functions allowing forms processing to be spread out over several page requests, thus ensuring that the processing does not get interrupted because of a PHP timeout, while allowing the user to receive feedback on the progress of the ongoing operations.<p>
The API is primarily designed to integrate nicely with the Form API workflow, but can also be used by non-FAPI scripts (like <a class="el" href="update_8php.html">update.php</a>) or even simple page callbacks (which should probably be used sparingly).<p>
Example: <div class="fragment"><pre class="fragment"> $batch = array(
   <span class="stringliteral">'title'</span> =&gt; <a class="code" href="common_8inc.html#41d20f0c822bf1f3c26a97981c762665">t</a>(<span class="stringliteral">'Exporting'</span>),
   <span class="stringliteral">'operations'</span> =&gt; array(
     array(<span class="stringliteral">'my_function_1'</span>, array($account-&gt;uid, <span class="stringliteral">'story'</span>)),
     array(<span class="stringliteral">'my_function_2'</span>, array()),
   ),
   <span class="stringliteral">'finished'</span> =&gt; <span class="stringliteral">'my_finished_callback'</span>,
   <span class="stringliteral">'file'</span> =&gt; <span class="stringliteral">'path_to_file_containing_myfunctions'</span>,
 );
 <a class="code" href="group__batch.html#g9ff3f18b3bdd1d62ab7ac681a22a7170">batch_set</a>($batch);
 <span class="comment">// only needed if not inside a form _submit handler :</span>
 <a class="code" href="group__batch.html#g35560f242c9a5da0d136e652d4d1da47">batch_process</a>();
</pre></div><p>
Note: if the batch 'title', 'init_message', 'progress_message', or 'error_message' could contain any user input, it is the responsibility of the code calling <a class="el" href="group__batch.html#g9ff3f18b3bdd1d62ab7ac681a22a7170">batch_set()</a> to sanitize them first with a function like <a class="el" href="bootstrap_8inc.html#76fc67a30fd8d75ddd80565e6e65a13d">check_plain()</a> or filter_xss().<p>
Sample batch operations: <div class="fragment"><pre class="fragment"> <span class="comment">// Simple and artificial: load a node of a given type for a given user</span>
 function my_function_1($uid, $type, &amp;$context) {
   <span class="comment">// The $context array gathers batch context information about the execution (read),</span>
   <span class="comment">// as well as 'return values' for the current operation (write)</span>
   <span class="comment">// The following keys are provided :</span>
   <span class="comment">// 'results' (read / write): The array of results gathered so far by</span>
   <span class="comment">//   the batch processing, for the current operation to append its own.</span>
   <span class="comment">// 'message' (write): A text message displayed in the progress page.</span>
   <span class="comment">// The following keys allow for multi-step operations :</span>
   <span class="comment">// 'sandbox' (read / write): An array that can be freely used to</span>
   <span class="comment">//   store persistent data between iterations. It is recommended to</span>
   <span class="comment">//   use this instead of $_SESSION, which is unsafe if the user</span>
   <span class="comment">//   continues browsing in a separate window while the batch is processing.</span>
   <span class="comment">// 'finished' (write): A float number between 0 and 1 informing</span>
   <span class="comment">//   the processing engine of the completion level for the operation.</span>
   <span class="comment">//   1 (or no value explicitly set) means the operation is finished</span>
   <span class="comment">//   and the batch processing can continue to the next operation.</span>

   $node = node_load(array(<span class="stringliteral">'uid'</span> =&gt; $uid, <span class="stringliteral">'type'</span> =&gt; $type));
   $context[<span class="stringliteral">'results'</span>][] = $node-&gt;nid .<span class="stringliteral">' : '</span>. $node-&gt;title;
   $context[<span class="stringliteral">'message'</span>] = $node-&gt;title;
 }

 <span class="comment">// More advanced example: multi-step operation - load all nodes, five by five</span>
 function my_function_2(&amp;$context) {
   <span class="keywordflow">if</span> (empty($context[<span class="stringliteral">'sandbox'</span>])) {
     $context[<span class="stringliteral">'sandbox'</span>][<span class="stringliteral">'progress'</span>] = 0;
     $context[<span class="stringliteral">'sandbox'</span>][<span class="stringliteral">'current_node'</span>] = 0;
     $context[<span class="stringliteral">'sandbox'</span>][<span class="stringliteral">'max'</span>] = <a class="code" href="database_8mysql_8inc.html#953354ea01b236440b187210dc18aad9">db_result</a>(<a class="code" href="database_8mysql-common_8inc.html#9e096321b86945d128746ac7bedce8f3">db_query</a>(<span class="stringliteral">'SELECT COUNT(DISTINCT nid) FROM {node}'</span>));
   }
   $limit = 5;
   $result = <a class="code" href="database_8mysql_8inc.html#893cbcab2ecf321005eae4e278adc22b">db_query_range</a>(<span class="stringliteral">"SELECT nid FROM {node} WHERE nid &gt; %d ORDER BY nid ASC"</span>, $context[<span class="stringliteral">'sandbox'</span>][<span class="stringliteral">'current_node'</span>], 0, $limit);
   <span class="keywordflow">while</span> ($row = <a class="code" href="database_8mysql_8inc.html#2bd5f98fec7f21ee2c37f6b83785dcb9">db_fetch_array</a>($result)) {
     $node = node_load($row[<span class="stringliteral">'nid'</span>], NULL, TRUE);
     $context[<span class="stringliteral">'results'</span>][] = $node-&gt;nid .<span class="stringliteral">' : '</span>. $node-&gt;title;
     $context[<span class="stringliteral">'sandbox'</span>][<span class="stringliteral">'progress'</span>]++;
     $context[<span class="stringliteral">'sandbox'</span>][<span class="stringliteral">'current_node'</span>] = $node-&gt;nid;
     $context[<span class="stringliteral">'message'</span>] = $node-&gt;title;
   }
   <span class="keywordflow">if</span> ($context[<span class="stringliteral">'sandbox'</span>][<span class="stringliteral">'progress'</span>] != $context[<span class="stringliteral">'sandbox'</span>][<span class="stringliteral">'max'</span>]) {
     $context[<span class="stringliteral">'finished'</span>] = $context[<span class="stringliteral">'sandbox'</span>][<span class="stringliteral">'progress'</span>] / $context[<span class="stringliteral">'sandbox'</span>][<span class="stringliteral">'max'</span>];
   }
 }
</pre></div><p>
Sample 'finished' callback: <div class="fragment"><pre class="fragment"> function batch_test_finished($success, $results, $operations) {
   <span class="keywordflow">if</span> ($success) {
     $message = <a class="code" href="group__format.html#g0acb4fb7ab13d4b5ca3267a253af2f74">format_plural</a>(count($results), <span class="stringliteral">'One post processed.'</span>, <span class="stringliteral">'@count posts processed.'</span>);
   }
   <span class="keywordflow">else</span> {
     $message = <a class="code" href="common_8inc.html#41d20f0c822bf1f3c26a97981c762665">t</a>(<span class="stringliteral">'Finished with an error.'</span>);
   }
   <a class="code" href="bootstrap_8inc.html#d9223d86c7b08b1288274ce211d9bfa6">drupal_set_message</a>($message);
   <span class="comment">// Providing data for the redirected page is done through $_SESSION.</span>
   <span class="keywordflow">foreach</span> ($results as $result) {
     $items[] = <a class="code" href="common_8inc.html#41d20f0c822bf1f3c26a97981c762665">t</a>(<span class="stringliteral">'Loaded node %title.'</span>, array(<span class="stringliteral">'%title'</span> =&gt; $result));
   }
   $_SESSION[<span class="stringliteral">'my_batch_results'</span>] = $items;
 }
</pre></div> <hr><h2>Function Documentation</h2>
<a class="anchor" name="g971f5246c6e8e536d0b20529fb2e2638"></a><!-- doxytag: member="form.inc::batch_get" ref="g971f5246c6e8e536d0b20529fb2e2638" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">&amp; batch_get           </td>
          <td>(</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Retrieves the current batch. 
</div>
</div><p>
<a class="anchor" name="g35560f242c9a5da0d136e652d4d1da47"></a><!-- doxytag: member="form.inc::batch_process" ref="g35560f242c9a5da0d136e652d4d1da47" args="($redirect=NULL, $url=NULL)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">batch_process           </td>
          <td>(</td>
          <td class="paramtype">$&nbsp;</td>
          <td class="paramname"> <em>redirect</em> = <code>NULL</code>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">$&nbsp;</td>
          <td class="paramname"> <em>url</em> = <code>NULL</code></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Processes the batch.<p>
Unless the batch has been marked with 'progressive' = FALSE, the function issues a drupal_goto and thus ends page execution.<p>
This function is not needed in form submit handlers; Form API takes care of batches that were set during form submission.<p>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>$redirect</em>&nbsp;</td><td>(optional) Path to redirect to when the batch has finished processing. </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>$url</em>&nbsp;</td><td>(optional - should only be used for separate scripts like <a class="el" href="update_8php.html">update.php</a>) URL of the batch processing page. </td></tr>
  </table>
</dl>

</div>
</div><p>
<a class="anchor" name="g9ff3f18b3bdd1d62ab7ac681a22a7170"></a><!-- doxytag: member="form.inc::batch_set" ref="g9ff3f18b3bdd1d62ab7ac681a22a7170" args="($batch_definition)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">batch_set           </td>
          <td>(</td>
          <td class="paramtype">$&nbsp;</td>
          <td class="paramname"> <em>batch_definition</em>          </td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Opens a new batch.<p>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>$batch</em>&nbsp;</td><td>An array defining the batch. The following keys can be used -- only 'operations' is required, and batch_init() provides default values for the messages.<ul>
<li>'operations': Array of function calls to be performed. Example: <div class="fragment"><pre class="fragment">     array(
       array(<span class="stringliteral">'my_function_1'</span>, array($arg1)),
       array(<span class="stringliteral">'my_function_2'</span>, array($arg2_1, $arg2_2)),
     )
</pre></div></li><li>'title': Title for the progress page. Only safe strings should be passed. Defaults to t('Processing').</li><li>'init_message': Message displayed while the processing is initialized. Defaults to t('Initializing.').</li><li>'progress_message': Message displayed while processing the batch. Available placeholders are , , , ,  and . Defaults to t('Completed  of .').</li><li>'error_message': Message displayed if an error occurred while processing the batch. Defaults to t('An error has occurred.').</li><li>'finished': Name of a function to be executed after the batch has completed. This should be used to perform any result massaging that may be needed, and possibly save data in $_SESSION for display after final page redirection.</li><li>'file': Path to the file containing the definitions of the 'operations' and 'finished' functions, for instance if they don't reside in the main .module file. The path should be relative to <a class="el" href="common_8inc.html#e227697e9c239f09fd7e36f71afde771">base_path()</a>, and thus should be built using <a class="el" href="common_8inc.html#e3bbe8f97bf07bb0eaf4580c98f9bf94">drupal_get_path()</a>.</li></ul>
</td></tr>
  </table>
</dl>
Operations are added as new batch sets. Batch sets are used to ensure clean code independence, ensuring that several batches submitted by different parts of the code (core / contrib modules) can be processed correctly while not interfering or having to cope with each other. Each batch set gets to specify his own UI messages, operates on its own set of operations and results, and triggers its own 'finished' callback. Batch sets are processed sequentially, with the progress bar starting fresh for every new set. 
</div>
</div><p>
</div>
<hr size="1"><address style="text-align: right;"><small>Generated on Sat Feb 12 18:59:46 2011 by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.8 </small></address>
</body>
</html>
